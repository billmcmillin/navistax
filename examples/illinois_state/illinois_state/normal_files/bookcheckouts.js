(function(d){d(function(){ep.require("ep/util/disablecontextmenu.js");d("body").delegate("a.ebook-title,a.ebook-ft",{click:function(a){c.checkBookAvailability(a,"online")},keypress:function(a){if(a.keyCode==="13"){c.checkBookAvailability(a,"online")}}});d("body").delegate("a.download",{click:function(a){c.checkBookAvailability(a,"offline")},keypress:function(a){if(a.keyCode==="13"){c.checkBookAvailability(a,"offline")}}});d("#SnippetsWidget, .treelist-group").on("click","[data-ppid]",function(a){var b=d(a.target);var f=b.parents(".snippet-content").data("ebook");c.checkBookAvailability(a,"online",f)});d(".treelist-group").on("click","[data-lpid]",function(a){var b=d(a.target);var h=b.parents(".treelist-group");var g=h.add(h.find("[data-ebook]")).filter("[data-ebook]").data("ebook");c.checkBookAvailability(a,"online",g)});d("body").bind("CheckAvailabilityOnLoad",function(b,a,e){c.checkBookAvailability(b,a,e)});ep.publish("bookcheckouts:checkBookAvailability:ready")});var c=function(){return{isDownloading:false,checkBookAvailability:function(b,j,k){if(c.isDownloading){b.preventDefault();return false}c.isDownloading=true;var l=true;var a=k?k:d(b.target).data("ebook");if(typeof(a)==="undefined"){a=k?k:d(b.target).data("abook");l=false}if(a.format==="EK"&&d.browser.msie&&parseInt(d.browser.version,10)<9){var n=ep.utilities.buildRouteKey(a.db,a.an,a.tag);d(b.target).epmodal({url:"UpgradeBrowser/EpubEbooks/"+ep.utilities.urlSafeEncodeBase64(n)});c.isDownloading=false;b.preventDefault();return false}var m={an:a.an,type:j,position:a.rid,doid:a.doid,format:a.format,isebook:l};d.ajax({url:ep.utilities.buildAjaxRequestPath("CheckoutDialog/CheckBookAvailability",{Db:a.db,Tag:a.tag,Term:a.an}),data:m,success:function(e){c.handleBookAvailability(j,d(b.target),e,a);c.isDownloading=false}});b.preventDefault()},handleBookAvailability:function(a,b,g,h){switch(a){case"online":if(g.isAvailable){c.openEbookViewer(b,h)}else{if(g.dialogData){d(b).epmodal({url:g.dialogData.url,controller:g.dialogData.controller,data:g.dialogData.data})}}break;case"offline":if(g.dialogData){d(b).epmodal({url:g.dialogData.url,controller:g.dialogData.controller,data:g.dialogData.data})}break}},openEbookViewer:function(a,b){if(b&&b.format){var i=a.closest("a[data-lpid]").data("lpid");var j=a.closest("a[data-ppid]").data("ppid");if(b.ppid){j=b.ppid}var h=ep.utilities.buildAjaxRequestPath("ebookviewer/ebook",{Db:b.db,Term:b.an,Tag:b.tag})+("&format="+b.format)+(i?"&lpid="+i:"")+(j?"&ppid="+j:"")+(b.rid?"&rid="+b.rid:"");window.location.href=h}}}}()})(jQuery);